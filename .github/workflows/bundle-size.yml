name: Bundle Size Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/bundle-size.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build bundle
        working-directory: ./frontend
        run: npm run build

      - name: Check bundle size
        working-directory: ./frontend
        run: npm run size

      - name: Save current bundle stats
        working-directory: ./frontend
        run: |
          npm run size:json > bundle-stats.json

      - name: Upload bundle visualizer
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats
          path: frontend/dist/stats.html
          retention-days: 30

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Set up Node.js for base
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (base)
        working-directory: ./base/frontend
        run: npm ci
        continue-on-error: true

      - name: Build bundle (base)
        working-directory: ./base/frontend
        run: npm run build
        continue-on-error: true

      - name: Get base bundle stats
        working-directory: ./base/frontend
        run: |
          npm run size:json > bundle-stats-base.json || echo '[]' > bundle-stats-base.json
        continue-on-error: true

      - name: Compare bundle sizes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read stats files
            let currentStats = [];
            let baseStats = [];
            
            try {
              currentStats = JSON.parse(fs.readFileSync('frontend/bundle-stats.json', 'utf8'));
            } catch (e) {
              console.error('Failed to read current stats:', e);
            }
            
            try {
              baseStats = JSON.parse(fs.readFileSync('base/frontend/bundle-stats-base.json', 'utf8'));
            } catch (e) {
              console.log('No base stats available');
            }
            
            function formatSize(bytes) {
              if (bytes < 1024) return `${bytes.toFixed(0)} B`;
              if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
              return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
            }
            
            function formatDiff(current, base) {
              if (!base || base === 0) return 'N/A';
              const diff = current - base;
              const pct = ((diff / base) * 100).toFixed(2);
              const sign = diff > 0 ? '+' : '';
              const emoji = diff > 0 ? 'ðŸ”´' : diff < 0 ? 'ðŸŸ¢' : 'âšª';
              return `${emoji} ${sign}${formatSize(diff)} (${sign}${pct}%)`;
            }
            
            let comment = '## ðŸ“¦ Bundle Size Report\n\n';
            comment += '| File | Current | Base | Diff |\n';
            comment += '|------|---------|------|------|\n';
            
            let anyExceeded = false;
            let significantIncrease = false;
            
            for (const item of currentStats) {
              const baseItem = baseStats.find(b => b.name === item.name);
              const baseSize = baseItem ? baseItem.size : null;
              
              comment += `| ${item.name} | ${formatSize(item.size)} | ${baseSize ? formatSize(baseSize) : 'N/A'} | ${formatDiff(item.size, baseSize)} |\n`;
              
              // Check if size exceeds limit
              if (!item.passed) {
                anyExceeded = true;
              }
              
              // Check for significant increases (>5% or >50KB)
              if (baseSize) {
                const diff = item.size - baseSize;
                const pctIncrease = (diff / baseSize) * 100;
                
                if (pctIncrease > 5 || diff > 50 * 1024) {
                  significantIncrease = true;
                }
              }
            }
            
            comment += '\n';
            
            // Report issues
            if (anyExceeded) {
              comment += '### âš ï¸ Bundle Size Limit Exceeded\n\n';
              for (const item of currentStats) {
                if (!item.passed) {
                  comment += `- âŒ ${item.name} (${formatSize(item.size)}) exceeds limit of ${formatSize(item.sizeLimit)}\n`;
                }
              }
              comment += '\n';
            }
            
            if (significantIncrease && !anyExceeded) {
              comment += '### âš ï¸ Significant Bundle Size Increase\n\n';
              for (const item of currentStats) {
                const baseItem = baseStats.find(b => b.name === item.name);
                if (baseItem) {
                  const diff = item.size - baseItem.size;
                  const pctIncrease = (diff / baseItem.size) * 100;
                  
                  if (pctIncrease > 5 || diff > 50 * 1024) {
                    comment += `- ${item.name} increased by ${formatSize(diff)} (${pctIncrease.toFixed(2)}%), exceeding the threshold of 5% or 50KB\n`;
                  }
                }
              }
              comment += '\n';
            }
            
            comment += '\nðŸ“Š [View detailed bundle analysis](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
            
            // Post or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Bundle Size Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
            
            // Fail if limits are exceeded
            if (anyExceeded) {
              core.setFailed('Bundle size exceeds configured limits');
            }
            
            // Warn about significant increases
            if (significantIncrease && !anyExceeded) {
              core.warning('Bundle size increased significantly (>5% or >50KB)');
            }

